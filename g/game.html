<!doctype html>
<html>
<head>
  <link rel="stylesheet" href="css/game.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1, minimum-scale=1, user-scalable=0">
  <title>game name</title>
</head>
<body>
  <!-- 开始 -->
  <section id="p1">
    <div class="btn-start " id="btnStart">开始游戏</div>
  </section>
  <!-- 游戏页面 -->
  <section id="p2">
    <div class="info">
      <span class="score">得分 <i> 0</i></span>
      <span class="time">20</span>
    </div>
    <p style="color:#fff">点到彩色方块+1分，点到黑色方块游戏结束</p>
    <div class="square">
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
      <span class="box"></span>
    </div>
  </section>
  <!-- 分享页面 -->
  <section id="p3">
    <span style="color:#fff;">游戏结束</span>
  </section>
  <script src="http://cdn.bootcss.com/zepto/1.1.4/zepto.min.js"></script>
  <script>
  // zepto touch.js
  !function(a){function i(a,b,c,d){return Math.abs(a-b)>=Math.abs(c-d)?a-b>0?"Left":"Right":c-d>0?"Up":"Down"}function j(){f=null,b.last&&(b.el.trigger("longTap"),b={})}function k(){f&&clearTimeout(f),f=null}function l(){c&&clearTimeout(c),d&&clearTimeout(d),e&&clearTimeout(e),f&&clearTimeout(f),c=d=e=f=null,b={}}function m(a){return("touch"==a.pointerType||a.pointerType==a.MSPOINTER_TYPE_TOUCH)&&a.isPrimary}function n(a,b){return a.type=="pointer"+b||a.type.toLowerCase()=="mspointer"+b}var c,d,e,f,h,b={},g=750;a(document).ready(function(){var o,p,s,t,q=0,r=0;"MSGesture"in window&&(h=new MSGesture,h.target=document.body),a(document).bind("MSGestureEnd",function(a){var c=a.velocityX>1?"Right":a.velocityX<-1?"Left":a.velocityY>1?"Down":a.velocityY<-1?"Up":null;c&&(b.el.trigger("swipe"),b.el.trigger("swipe"+c))}).on("touchstart MSPointerDown pointerdown",function(d){(!(t=n(d,"down"))||m(d))&&(s=t?d:d.touches[0],d.touches&&1===d.touches.length&&b.x2&&(b.x2=void 0,b.y2=void 0),o=Date.now(),p=o-(b.last||o),b.el=a("tagName"in s.target?s.target:s.target.parentNode),c&&clearTimeout(c),b.x1=s.pageX,b.y1=s.pageY,p>0&&250>=p&&(b.isDoubleTap=!0),b.last=o,f=setTimeout(j,g),h&&t&&h.addPointer(d.pointerId))}).on("touchmove MSPointerMove pointermove",function(a){(!(t=n(a,"move"))||m(a))&&(s=t?a:a.touches[0],k(),b.x2=s.pageX,b.y2=s.pageY,q+=Math.abs(b.x1-b.x2),r+=Math.abs(b.y1-b.y2))}).on("touchend MSPointerUp pointerup",function(f){(!(t=n(f,"up"))||m(f))&&(k(),b.x2&&Math.abs(b.x1-b.x2)>30||b.y2&&Math.abs(b.y1-b.y2)>30?e=setTimeout(function(){b.el.trigger("swipe"),b.el.trigger("swipe"+i(b.x1,b.x2,b.y1,b.y2)),b={}},0):"last"in b&&(30>q&&30>r?d=setTimeout(function(){var d=a.Event("tap");d.cancelTouch=l,b.el.trigger(d),b.isDoubleTap?(b.el&&b.el.trigger("doubleTap"),b={}):c=setTimeout(function(){c=null,b.el&&b.el.trigger("singleTap"),b={}},250)},0):b={}),q=r=0)}).on("touchcancel MSPointerCancel pointercancel",l),a(window).on("scroll",l)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(b){a.fn[b]=function(a){return this.on(b,a)}})}(Zepto);
  </script>

  <!-- 页面脚本 -->
  <script>
    $(function(){

      initSquare();

      $('.btn-start').on('tap',function(){
        var $p1=$('#p1'),
            $p2=$('#p2');
        $p1.hide();
        $p2.show();

        Game.init();
        Game.start();
      })
    })

    // 设置方格宽度/高度
    function initSquare(){
      var $square=$('.square'),
          width=$(window).width()||300;
      $square.css({
        width:width + 'px',
        height:width + 'px'
      });
    }

    // 方格类
    var Box=function(){
      // 方格内妹子
      this.girl=null;
      // 方格元素
      this.boxElement={};
      // 点击事件
      this.onTap=function(){
        // 方格里没有妹子
        if(!this.girl) return 0;
        // 点中不好看的妹子
        else if(this.girl.number===0) return -1;
        // 点中的妹子还可以被点击
        else if(this.girl.isLive){
          this.girl.isLive=false;
          return 1;
        }
        // 妹子已经被点击过了
        else return 0;
      };
    }

    // 妹子类
    var Girl=function(photo){
      // 妹子的编号
      this.number=-1;
      // 妹子在第几个方格
      this.box=-1;
      // 妹子照片
      this.photo='';
      // 是否还可以再点击
      this.isLive=true;
      // 初始化妹子的照片
      this.photo=photo;
      // 妹子出现
      this.active=function(){
        var girl=this,
            box=girl.box;
        box.boxElement.css('background-color',girl.photo);
        setTimeout(function(){
          girl.hide();
        },1000);
      }
      // 妹子隐藏
      this.hide=function(){
        // debugger
        this.isLive=true;
        this.box.boxElement.css('background-color','#7bc3fd');
        this.box.girl=null;
        this.onHide();
      }
      // 妹子隐藏扩展
      this.onHide=function(){};
    }

    // 游戏控制类
    var Game={
      // 游戏时间
      time:6,
      // 方格
      boxes:[],
      // 妹子照片
      girlPhoto:{
        0:'#000',
        1:'#09f',
        2:'#6ff',
        3:'#900',
        4:'#9fc',
        5:'#6f0',
        6:'#90c',
        7:'#99f',
        8:'#c36',
        9:'#ff6'
      },
      // 妹子
      girls:[],
      // 当前活动的方格
      activeBoxes:{},
      // 当前活动的妹子
      activeGirls:{},

      init:function(){
        var game=this;
        $('.box').each(function(i){
          var box=new Box();
          box.boxElement=$(this).on('tap',function(){
            // TODO：点中不好看的妹子，游戏结束
            var result=box.onTap();
            if(result<0){
              game.gameover();
            }
            else{
              game.changeScore(result);
            }
          });

          game.boxes.push(box);
        })

        // 创建妹子
        for(var i=0;i<10;i++){
          var girl=new Girl(game.girlPhoto[i]);
          girl.number=i;
          girl.onHide=function(){
            var boxIndex=$.inArray(this.box,game.boxes);
            game.activeBoxes[boxIndex]=null;
            game.activeGirls[this.number]=null;
          }
          this.girls.push(girl);
        }
      },
      // 游戏开始
      start:function(){
        this.randomGirl();
        this.countdown();
      },
      // 游戏结束
      gameover:function(){
        this.time=-1;
        $('#p2').hide();
        $('#p3').show();
      },
      // 倒计时
      countdown:function(){
        var game=this,
            $timeEle=$('.time');
        game.time-=1;
        $timeEle.html(game.time);
        if(this.time>0){
          setTimeout(function(){
            game.countdown();
          },1000)
        }
      },
      // 让妹子随机出现在方格
      randomGirl:function(){
        if(this.time<=0){
          this.gameover();
          return;
        }
        var game=this,
            boxIndex=Math.floor(Math.random()*9),
            girlIndex=Math.floor(Math.random()*10),
            box,girl;

        while(game.activeBoxes[boxIndex]){
          boxIndex=Math.floor(Math.random()*9);
        }
        box=game.boxes[boxIndex];

        while(game.activeGirls[girlIndex]){
          girlIndex=Math.floor(Math.random()*10);
        }
        girl=game.girls[girlIndex];

        girl.box=box;
        box.girl=girl;

        game.activeBoxes[boxIndex]=true;
        game.activeGirls[girlIndex]=true;

        girl.active();

        setTimeout(function(){game.randomGirl()},200)
      },

      // 修改得分
      changeScore:function(score){
        var scoreEle=$('.score i'),
            newScore=parseInt(scoreEle.html())+score;
        scoreEle.html(newScore);
      }
    }

  </script>
</body>
</html>